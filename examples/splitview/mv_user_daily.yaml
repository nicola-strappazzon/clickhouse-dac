---
database:
  name: splitview
view:
  name: mv_user_daily
  to: agg_user_daily
  delete: true
  materialized: true
  populate: backfill
  query: |
    SELECT
        event_date,
        user_id,
        device,
        countState()                                  AS events_cnt,
        sumState(amount)                              AS amount_sum,
        uniqCombinedState(event_name)                 AS uniq_events,
        topKState(5)(event_name)                      AS top_events,
        quantilesTDigestState(0.5, 0.9, 0.99)(amount) AS amount_q
    FROM events
    GROUP BY event_date, user_id, device
